name: Deploy to PythonAnywhere

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Prepare deployment
        run: |
          echo "==== æº–å‚™éƒ¨ç½² ===="
          
          # è¨­ç½®èª¿è©¦æ¨¡å¼
          set -ex
          
          # é¡¯ç¤ºå·¥ä½œç©ºé–“æ ¹ç›®éŒ„
          echo "å·¥ä½œç©ºé–“æ ¹ç›®éŒ„:"
          pwd
          
          # å‰µå»ºä¸€å€‹ç°¡å–®çš„éƒ¨ç½²æ–‡ä»¶åˆ—è¡¨ï¼ˆé™¤äº†cacheå’Œdataç›®éŒ„ï¼‰
          echo "å‰µå»ºéƒ¨ç½²æ–‡ä»¶åˆ—è¡¨..."
          find . -type f \
            -not -path "*/\.*" \
            -not -path "*/venv/*" \
            -not -path "*/cache/*" \
            -not -path "*/app/data/*" \
            > deploy_files.txt
          
          # é¡¯ç¤ºå°‡è¦éƒ¨ç½²çš„æ–‡ä»¶æ•¸é‡å’Œé¡å‹
          echo "å°‡éƒ¨ç½² $(wc -l < deploy_files.txt) å€‹æ–‡ä»¶"
          echo "HTMLæ–‡ä»¶æ•¸é‡: $(grep -c "\.html$" deploy_files.txt)"
          echo "Pythonæ–‡ä»¶æ•¸é‡: $(grep -c "\.py$" deploy_files.txt)"
          
          # æª¢æŸ¥é—œéµæ–‡ä»¶æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
          echo "æª¢æŸ¥é—œéµæ–‡ä»¶..."
          for file in "app/templates/common/layout.html" "app/templates/japanese/index.html" "app/routes/japanese_routes.py"; do
            if grep -q "$file" deploy_files.txt; then
              echo "âœ… $file åœ¨éƒ¨ç½²åˆ—è¡¨ä¸­"
            else
              echo "âŒ $file ä¸åœ¨éƒ¨ç½²åˆ—è¡¨ä¸­!"
            fi
          done
      
      - name: Deploy to PythonAnywhere
        run: |
          echo "==== é–‹å§‹éƒ¨ç½² ===="
          
          # è¨­ç½®èª¿è©¦æ¨¡å¼
          set -ex
          
          # è¨­å®šåŸºæœ¬è®Šé‡
          BASE_DIR="/home/${{ secrets.PA_USERNAME }}/learnflask"
          API_TOKEN="${{ secrets.PA_API_TOKEN }}"
          API_BASE="https://www.pythonanywhere.com/api/v0/user/${{ secrets.PA_USERNAME }}"
          
          # æ­¥é©Ÿ1: æ”¶é›†ç›®éŒ„åˆ—è¡¨ä¸¦ç¢ºä¿æ‰€æœ‰ç›®éŒ„å­˜åœ¨
          echo "å‰µå»ºæ‰€æœ‰å¿…è¦çš„ç›®éŒ„..."
          DIRS=$(cat deploy_files.txt | xargs -I{} dirname {} | sort | uniq)
          echo "$DIRS" > directories.txt
          
          # å‰µå»ºé …ç›®æ ¹ç›®éŒ„
          echo "å‰µå»ºé …ç›®æ ¹ç›®éŒ„: $BASE_DIR"
          curl -X POST "$API_BASE/files/path$BASE_DIR/" \
            -H "Authorization: Token $API_TOKEN" || true
          
          # å‰µå»ºæ‰€æœ‰ç›®éŒ„ï¼ŒåŒ…æ‹¬åµŒå¥—ç›®éŒ„
          cat directories.txt | while read dir; do
            # è·³éç•¶å‰ç›®éŒ„
            if [ "$dir" = "." ]; then
              continue
            fi
            
            # æŠŠç›¸å°è·¯å¾‘è½‰ç‚º PythonAnywhere ä¸Šçš„çµ•å°è·¯å¾‘
            remote_dir="$BASE_DIR/${dir#./}"
            echo "å‰µå»ºç›®éŒ„: $remote_dir"
            
            # å‰µå»ºç›®éŒ„
            curl -X POST "$API_BASE/files/path$remote_dir/" \
              -H "Authorization: Token $API_TOKEN" || true
          done
          
          # æ­¥é©Ÿ2: å‰µå»ºç©ºçš„ data å’Œ cache ç›®éŒ„
          echo "å‰µå»º data å’Œ cache ç›®éŒ„..."
          for dir in app/data cache; do
            remote_dir="$BASE_DIR/$dir"
            echo "å‰µå»ºç›®éŒ„: $remote_dir"
            curl -X POST "$API_BASE/files/path$remote_dir/" \
              -H "Authorization: Token $API_TOKEN" || true
          done
          
          # æ­¥é©Ÿ3: ä¸Šå‚³æ‰€æœ‰æ–‡ä»¶
          echo "ä¸Šå‚³æ‰€æœ‰æ–‡ä»¶..."
          TOTAL_FILES=$(wc -l < deploy_files.txt)
          COUNTER=0
          SUCCESS=0
          FAILED=0
          ERRORS_LOG=""
          
          # å‰µå»ºå…©å€‹å‡½æ•¸ç”¨æ–¼ä¸Šå‚³æ–‡ä»¶å’Œé‡è©¦
          upload_file() {
            local file=$1
            local remote_file="$BASE_DIR/${file#./}"
            
            # ä¸Šå‚³æ–‡ä»¶
            local status_code=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "$API_BASE/files/path$remote_file" \
              -H "Authorization: Token $API_TOKEN" \
              -F "content=@$file" \
              -F "path=$remote_file")
              
            echo "$status_code"
          }
          
          retry_upload() {
            local file=$1
            local remote_file="$BASE_DIR/${file#./}"
            local retry_count=$2
            
            echo "ğŸ”„ å˜—è©¦é‡æ–°ä¸Šå‚³ $file (å˜—è©¦ $retry_count)..."
            # ä½¿ç”¨è©³ç´°è¼¸å‡ºé€²è¡Œèª¿è©¦
            curl -v -X POST "$API_BASE/files/path$remote_file" \
              -H "Authorization: Token $API_TOKEN" \
              -F "content=@$file" \
              -F "path=$remote_file"
          }
          
          # é–‹å§‹ä¸Šå‚³æ‰€æœ‰æ–‡ä»¶
          cat deploy_files.txt | while read file; do
            # æ›´æ–°è¨ˆæ•¸å™¨
            COUNTER=$((COUNTER+1))
            
            # é¡¯ç¤ºé€²åº¦
            echo "[$COUNTER/$TOTAL_FILES] ä¸Šå‚³æ–‡ä»¶: $file"
            
            # ä¸Šå‚³æ–‡ä»¶
            STATUS_CODE=$(upload_file "$file")
              
            # æª¢æŸ¥ä¸Šå‚³çµæœ
            if [ "$STATUS_CODE" = "200" ] || [ "$STATUS_CODE" = "201" ]; then
              echo "âœ… æ–‡ä»¶ä¸Šå‚³æˆåŠŸ: $file (HTTP $STATUS_CODE)"
              SUCCESS=$((SUCCESS+1))
            else
              echo "âŒ æ–‡ä»¶ä¸Šå‚³å¤±æ•—: $file (HTTP $STATUS_CODE)"
              FAILED=$((FAILED+1))
              ERRORS_LOG="$ERRORS_LOG\n$file (HTTP $STATUS_CODE)"
              
              # å°å¤±æ•—çš„æ–‡ä»¶é€²è¡Œé‡è©¦
              retry_upload "$file" 1
              RETRY_STATUS=$(upload_file "$file")
              
              if [ "$RETRY_STATUS" = "200" ] || [ "$RETRY_STATUS" = "201" ]; then
                echo "âœ… é‡è©¦æˆåŠŸ: $file (HTTP $RETRY_STATUS)"
                SUCCESS=$((SUCCESS+1))
                FAILED=$((FAILED-1))
                # å¾éŒ¯èª¤æ—¥èªŒä¸­ç§»é™¤
                ERRORS_LOG=$(echo "$ERRORS_LOG" | grep -v "$file")
              else
                echo "âŒ é‡è©¦å¤±æ•—: $file (HTTP $RETRY_STATUS)"
                # æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œä½¿ç”¨æœ€è©³ç´°çš„èª¿è©¦
                retry_upload "$file" 2
              fi
            fi
          done
          
          # æ­¥é©Ÿ4: é©—è­‰éƒ¨ç½²çµæœ
          echo "é©—è­‰éƒ¨ç½²..."
          CRITICAL_DIRS="app/templates app/templates/common app/templates/japanese app/routes"
          for dir in $CRITICAL_DIRS; do
            echo "åˆ—å‡º $dir ç›®éŒ„å…§å®¹:"
            curl -sS "$API_BASE/files/path$BASE_DIR/$dir/" \
              -H "Authorization: Token $API_TOKEN" 
            echo ""
          done
          
          # é¡¯ç¤ºéƒ¨ç½²çµ±è¨ˆ
          echo "==== éƒ¨ç½²çµ±è¨ˆ ===="
          echo "ç¸½å…±æ–‡ä»¶: $TOTAL_FILES"
          echo "æˆåŠŸä¸Šå‚³: $SUCCESS"
          echo "å¤±æ•—ä¸Šå‚³: $FAILED"
          if [ "$FAILED" -gt 0 ]; then
            echo -e "å¤±æ•—çš„æ–‡ä»¶:$ERRORS_LOG"
          fi
          
          # é‡æ–°åŠ è¼‰æ‡‰ç”¨
          echo "é‡æ–°åŠ è¼‰ Web æ‡‰ç”¨..."
          curl -X POST "$API_BASE/webapps/${{ secrets.PA_USERNAME }}.pythonanywhere.com/reload/" \
            -H "Authorization: Token $API_TOKEN"
            
          echo "éƒ¨ç½²å®Œæˆ!"

