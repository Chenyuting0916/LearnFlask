name: Deploy to PythonAnywhere

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # ç²å–æ‰€æœ‰æ­·å²è¨˜éŒ„ï¼Œå¹«åŠ©æ›´å¥½åœ°æª¢æ¸¬è®Šæ›´
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Prepare deployment
        run: |
          echo "==== æº–å‚™éƒ¨ç½² ===="
          
          # è¨­ç½®èª¿è©¦æ¨¡å¼
          set -ex
          
          # é¡¯ç¤ºå·¥ä½œç©ºé–“æ ¹ç›®éŒ„
          echo "å·¥ä½œç©ºé–“æ ¹ç›®éŒ„:"
          pwd
          
          # å‰µå»ºä¸€å€‹ç°¡å–®çš„éƒ¨ç½²æ–‡ä»¶åˆ—è¡¨ï¼ˆé™¤äº†cacheå’Œdataç›®éŒ„ï¼‰
          echo "å‰µå»ºéƒ¨ç½²æ–‡ä»¶åˆ—è¡¨..."
          find . -type f \
            -not -path "*/\.*" \
            -not -path "*/venv/*" \
            -not -path "*/cache/*" \
            -not -path "*/__pycache__/*" \
            -not -path "*/app/data/*" \
            > deploy_files.txt
          
          # é¡¯ç¤ºå°‡è¦éƒ¨ç½²çš„æ–‡ä»¶æ•¸é‡å’Œé¡å‹
          echo "å°‡éƒ¨ç½² $(wc -l < deploy_files.txt) å€‹æ–‡ä»¶"
          echo "HTMLæ–‡ä»¶æ•¸é‡: $(grep -c "\.html$" deploy_files.txt)"
          echo "Pythonæ–‡ä»¶æ•¸é‡: $(grep -c "\.py$" deploy_files.txt)"
          
          # æª¢æŸ¥é—œéµæ–‡ä»¶æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
          echo "æª¢æŸ¥é—œéµæ–‡ä»¶..."
          for file in "app/templates/common/layout.html" "app/templates/japanese/index.html" "app/routes/japanese_routes.py"; do
            if grep -q "$file" deploy_files.txt; then
              echo "âœ… $file åœ¨éƒ¨ç½²åˆ—è¡¨ä¸­"
            else
              echo "âŒ $file ä¸åœ¨éƒ¨ç½²åˆ—è¡¨ä¸­!"
            fi
          done
      
      - name: Deploy to PythonAnywhere
        run: |
          echo "==== é–‹å§‹éƒ¨ç½² ===="
          
          # è¨­ç½®èª¿è©¦æ¨¡å¼
          set -ex
          
          # è¨­å®šåŸºæœ¬è®Šé‡
          BASE_DIR="/home/${{ secrets.PA_USERNAME }}/learnflask"
          API_TOKEN="${{ secrets.PA_API_TOKEN }}"
          API_BASE="https://www.pythonanywhere.com/api/v0/user/${{ secrets.PA_USERNAME }}"
          
          # æ­¥é©Ÿ1: æ”¶é›†ç›®éŒ„åˆ—è¡¨ä¸¦ç¢ºä¿æ‰€æœ‰ç›®éŒ„å­˜åœ¨
          echo "å‰µå»ºæ‰€æœ‰å¿…è¦çš„ç›®éŒ„..."
          DIRS=$(cat deploy_files.txt | xargs -I{} dirname {} | sort | uniq)
          echo "$DIRS" > directories.txt
          
          # å‰µå»ºé …ç›®æ ¹ç›®éŒ„
          echo "å‰µå»ºé …ç›®æ ¹ç›®éŒ„: $BASE_DIR"
          curl -X POST "$API_BASE/files/path$BASE_DIR/" \
            -H "Authorization: Token $API_TOKEN" || true
          
          # å‰µå»ºæ‰€æœ‰ç›®éŒ„ï¼ŒåŒ…æ‹¬åµŒå¥—ç›®éŒ„
          cat directories.txt | while read dir; do
            # è·³éç•¶å‰ç›®éŒ„
            if [ "$dir" = "." ]; then
              continue
            fi
            
            # æŠŠç›¸å°è·¯å¾‘è½‰ç‚º PythonAnywhere ä¸Šçš„çµ•å°è·¯å¾‘
            remote_dir="$BASE_DIR/${dir#./}"
            echo "å‰µå»ºç›®éŒ„: $remote_dir"
            
            # å‰µå»ºç›®éŒ„
            curl -X POST "$API_BASE/files/path$remote_dir/" \
              -H "Authorization: Token $API_TOKEN" || true
              
            # æ·»åŠ å»¶é²ä»¥é¿å…é”åˆ° API é™åˆ¶
            sleep 0.5
          done
          
          # æ­¥é©Ÿ2: å‰µå»ºç©ºçš„ data å’Œ cache ç›®éŒ„
          echo "å‰µå»º data å’Œ cache ç›®éŒ„..."
          for dir in app/data cache; do
            remote_dir="$BASE_DIR/$dir"
            echo "å‰µå»ºç›®éŒ„: $remote_dir"
            curl -X POST "$API_BASE/files/path$remote_dir/" \
              -H "Authorization: Token $API_TOKEN" || true
            sleep 0.5
          done
          
          # æ­¥é©Ÿ3: ä¸Šå‚³æ‰€æœ‰æ–‡ä»¶ï¼Œç¢ºä¿å¼·åˆ¶è¦†è“‹
          echo "ä¸Šå‚³æ‰€æœ‰æ–‡ä»¶..."
          TOTAL_FILES=$(wc -l < deploy_files.txt)
          COUNTER=0
          SUCCESS=0
          FAILED=0
          ERRORS_LOG=""
          TEMPLATES_LOG=""
          
          # å‰µå»ºå‡½æ•¸ç”¨æ–¼è™•ç†æ–‡ä»¶ä¸Šå‚³
          upload_file() {
            local file=$1
            local remote_file="$BASE_DIR/${file#./}"
            
            # é¦–å…ˆå¼·åˆ¶åˆªé™¤ç¾æœ‰æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            echo "åˆªé™¤ç¾æœ‰æ–‡ä»¶: $remote_file"
            curl -s -X DELETE "$API_BASE/files/path$remote_file" \
              -H "Authorization: Token $API_TOKEN" > /dev/null
              
            # æš«åœä»¥é¿å… API é€Ÿç‡é™åˆ¶
            sleep 0.5
              
            # ç„¶å¾Œä¸Šå‚³æ–°æ–‡ä»¶
            echo "ä¸Šå‚³æ–°æ–‡ä»¶: $file -> $remote_file"
            local status_code=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "$API_BASE/files/path$remote_file" \
              -H "Authorization: Token $API_TOKEN" \
              -F "content=@$file" \
              -F "path=$remote_file")
              
            echo "$status_code"
          }
          
          retry_upload() {
            local file=$1
            local remote_file="$BASE_DIR/${file#./}"
            local retry_count=$2
            local sleep_time=$3
            
            echo "ğŸ”„ å˜—è©¦é‡æ–°ä¸Šå‚³ $file (å˜—è©¦ $retry_count)ï¼Œç­‰å¾… ${sleep_time}ç§’..."
            
            # ç­‰å¾…æŒ‡å®šçš„æ™‚é–“ (æŒ‡æ•¸é€€é¿ç­–ç•¥)
            sleep $sleep_time
            
            # å¼·åˆ¶åˆªé™¤ç¾æœ‰æ–‡ä»¶
            curl -s -X DELETE "$API_BASE/files/path$remote_file" \
              -H "Authorization: Token $API_TOKEN" > /dev/null 2>&1
              
            sleep 0.5
              
            # ä½¿ç”¨è©³ç´°è¼¸å‡ºé€²è¡Œèª¿è©¦
            local retry_status=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "$API_BASE/files/path$remote_file" \
              -H "Authorization: Token $API_TOKEN" \
              -F "content=@$file" \
              -F "path=$remote_file")
            
            echo "$retry_status"
          }
          
          # é–‹å§‹ä¸Šå‚³æ‰€æœ‰æ–‡ä»¶ï¼Œæ‰¹æ¬¡è™•ç†ä¸¦æ·»åŠ å»¶é²
          # æ¯ä¸Šå‚³10å€‹æ–‡ä»¶æš«åœ5ç§’ï¼Œé¿å…é€Ÿç‡é™åˆ¶
          BATCH_SIZE=5
          BATCH_COUNT=0
          
          cat deploy_files.txt | while read file; do
            # æ›´æ–°è¨ˆæ•¸å™¨
            COUNTER=$((COUNTER+1))
            BATCH_COUNT=$((BATCH_COUNT+1))
            
            # é¡¯ç¤ºé€²åº¦
            echo "[$COUNTER/$TOTAL_FILES] ä¸Šå‚³æ–‡ä»¶: $file"
            
            # ä¸Šå‚³æ–‡ä»¶ï¼ˆä½¿ç”¨æ”¹é€²çš„ä¸Šå‚³å‡½æ•¸ç¢ºä¿è¦†è“‹ï¼‰
            STATUS_CODE=$(upload_file "$file")
              
            # æª¢æŸ¥ä¸Šå‚³çµæœ
            if [ "$STATUS_CODE" = "200" ] || [ "$STATUS_CODE" = "201" ]; then
              echo "âœ… æ–‡ä»¶ä¸Šå‚³æˆåŠŸ: $file (HTTP $STATUS_CODE)"
              SUCCESS=$((SUCCESS+1))
              
              # ç‰¹åˆ¥è¨˜éŒ„æ¨¡æ¿æ–‡ä»¶
              if [[ $file == *".html"* ]]; then
                TEMPLATES_LOG="$TEMPLATES_LOG\n$file"
              fi
            else
              # å¦‚æœé‡åˆ°429éŒ¯èª¤ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰ï¼Œä½¿ç”¨æŒ‡æ•¸é€€é¿ç­–ç•¥é‡è©¦
              if [ "$STATUS_CODE" = "429" ]; then
                echo "âš ï¸ é‡åˆ°é€Ÿç‡é™åˆ¶: $file (HTTP 429)"
                
                # ç¬¬ä¸€æ¬¡é‡è©¦ç­‰å¾…5ç§’
                echo "ç­‰å¾…5ç§’å¾Œé‡è©¦..."
                RETRY_STATUS=$(retry_upload "$file" 1 5)
                
                if [ "$RETRY_STATUS" = "200" ] || [ "$RETRY_STATUS" = "201" ]; then
                  echo "âœ… é‡è©¦æˆåŠŸ: $file (HTTP $RETRY_STATUS)"
                  SUCCESS=$((SUCCESS+1))
                elif [ "$RETRY_STATUS" = "429" ]; then
                  # ç¬¬äºŒæ¬¡é‡è©¦ç­‰å¾…15ç§’
                  echo "ç¹¼çºŒé‡åˆ°é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…15ç§’å¾Œé‡è©¦..."
                  RETRY_STATUS=$(retry_upload "$file" 2 15)
                  
                  if [ "$RETRY_STATUS" = "200" ] || [ "$RETRY_STATUS" = "201" ]; then
                    echo "âœ… é‡è©¦æˆåŠŸ: $file (HTTP $RETRY_STATUS)"
                    SUCCESS=$((SUCCESS+1))
                  elif [ "$RETRY_STATUS" = "429" ]; then
                    # ç¬¬ä¸‰æ¬¡é‡è©¦ç­‰å¾…30ç§’
                    echo "ç¹¼çºŒé‡åˆ°é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…30ç§’å¾Œæœ€å¾Œé‡è©¦..."
                    RETRY_STATUS=$(retry_upload "$file" 3 30)
                    
                    if [ "$RETRY_STATUS" = "200" ] || [ "$RETRY_STATUS" = "201" ]; then
                      echo "âœ… æœ€çµ‚é‡è©¦æˆåŠŸ: $file (HTTP $RETRY_STATUS)"
                      SUCCESS=$((SUCCESS+1))
                    else
                      echo "âŒ å¤šæ¬¡é‡è©¦å¾Œä»ç„¶å¤±æ•—: $file (HTTP $RETRY_STATUS)"
                      FAILED=$((FAILED+1))
                      ERRORS_LOG="$ERRORS_LOG\n$file (HTTP $RETRY_STATUS)"
                    fi
                  else
                    echo "âŒ é‡è©¦å¤±æ•—: $file (HTTP $RETRY_STATUS)"
                    FAILED=$((FAILED+1))
                    ERRORS_LOG="$ERRORS_LOG\n$file (HTTP $RETRY_STATUS)"
                  fi
                else
                  echo "âŒ é‡è©¦å¤±æ•—: $file (HTTP $RETRY_STATUS)"
                  FAILED=$((FAILED+1))
                  ERRORS_LOG="$ERRORS_LOG\n$file (HTTP $RETRY_STATUS)"
                fi
              else
                echo "âŒ æ–‡ä»¶ä¸Šå‚³å¤±æ•—: $file (HTTP $STATUS_CODE)"
                RETRY_STATUS=$(retry_upload "$file" 1 3)
                
                if [ "$RETRY_STATUS" = "200" ] || [ "$RETRY_STATUS" = "201" ]; then
                  echo "âœ… é‡è©¦æˆåŠŸ: $file (HTTP $RETRY_STATUS)"
                  SUCCESS=$((SUCCESS+1))
                else
                  FAILED=$((FAILED+1))
                  ERRORS_LOG="$ERRORS_LOG\n$file (HTTP $RETRY_STATUS)"
                  echo "âŒ é‡è©¦å¤±æ•—: $file (HTTP $RETRY_STATUS)"
                fi
              fi
            fi
            
            # æ¯ä¸Šå‚³ä¸€æ‰¹æ–‡ä»¶å¾Œæš«åœ
            if [ "$BATCH_COUNT" -ge "$BATCH_SIZE" ]; then
              echo "å·²ä¸Šå‚³ $BATCH_SIZE å€‹æ–‡ä»¶ï¼Œæš«åœ5ç§’é¿å…é€Ÿç‡é™åˆ¶..."
              sleep 5
              BATCH_COUNT=0
            else
              # æ¯å€‹æ–‡ä»¶ä¹‹é–“çš„è¼•å¾®å»¶é²
              sleep 0.5
            fi
          done
          
          # æ¸…ç† __pycache__ å’Œ .pyc æ–‡ä»¶
          echo "æ¸…ç† Python ç·©å­˜æ–‡ä»¶..."
          curl -X POST "$API_BASE/consoles/" \
            -H "Authorization: Token $API_TOKEN" \
            -d "executable=bash" \
            -d "arguments=" \
            -d "working_directory=/home/${{ secrets.PA_USERNAME }}/learnflask" \
            > console_response.json
          
          CONSOLE_ID=$(cat console_response.json | grep -o '"id":[^,]*' | cut -d':' -f2 | tr -d ' "')
          
          if [ ! -z "$CONSOLE_ID" ]; then
            echo "åŸ·è¡Œæ¸…ç†å‘½ä»¤ï¼ŒConsole ID: $CONSOLE_ID"
            # ç­‰å¾…æ§åˆ¶å°å°±ç·’
            sleep 2
            
            # ç™¼é€å‘½ä»¤æ¸…ç† __pycache__ ç›®éŒ„å’Œ .pyc æ–‡ä»¶ï¼Œä½†æ’é™¤ data å’Œ cache ç›®éŒ„
            curl -X POST "$API_BASE/consoles/$CONSOLE_ID/send_input/" \
              -H "Authorization: Token $API_TOKEN" \
              -d "input=find . -path \"*/app/data\" -prune -o -path \"*/cache\" -prune -o -name \"__pycache__\" -type d -exec rm -rf {} + 2>/dev/null || true"
              
            curl -X POST "$API_BASE/consoles/$CONSOLE_ID/send_input/" \
              -H "Authorization: Token $API_TOKEN" \
              -d "input=find . -path \"*/app/data\" -prune -o -path \"*/cache\" -prune -o -name \"*.pyc\" -delete"
          else
            echo "ç„¡æ³•å‰µå»ºæ§åˆ¶å°ï¼Œè·³éæ¸…ç†æ­¥é©Ÿ"
          fi
          
          # é©—è­‰éƒ¨ç½²çµæœ
          echo "é©—è­‰éƒ¨ç½²..."
          CRITICAL_DIRS="app/templates app/templates/auth app/templates/common app/templates/japanese app/routes"
          for dir in $CRITICAL_DIRS; do
            echo "åˆ—å‡º $dir ç›®éŒ„å…§å®¹:"
            curl -sS "$API_BASE/files/path$BASE_DIR/$dir/" \
              -H "Authorization: Token $API_TOKEN" 
            echo ""
            sleep 1  # æ·»åŠ å»¶é²é¿å…é€Ÿç‡é™åˆ¶
          done
          
          # é¡¯ç¤ºéƒ¨ç½²çµ±è¨ˆ
          echo "==== éƒ¨ç½²çµ±è¨ˆ ===="
          echo "ç¸½å…±æ–‡ä»¶: $TOTAL_FILES"
          echo "æˆåŠŸä¸Šå‚³: $SUCCESS"
          echo "å¤±æ•—ä¸Šå‚³: $FAILED"
          if [ "$FAILED" -gt 0 ]; then
            echo -e "å¤±æ•—çš„æ–‡ä»¶:$ERRORS_LOG"
          fi
          
          # é›™é‡ä¿éšªï¼šé‡æ–°åŠ è¼‰ Web æ‡‰ç”¨
          echo "é‡æ–°åŠ è¼‰ Web æ‡‰ç”¨..."
          # æ–¹æ³•1ï¼šä½¿ç”¨ API é‡æ–°åŠ è¼‰
          curl -X POST "$API_BASE/webapps/${{ secrets.PA_USERNAME }}.pythonanywhere.com/reload/" \
            -H "Authorization: Token $API_TOKEN"
            
          # æ–¹æ³•2ï¼šè§¸ç¢° WSGI æ–‡ä»¶
          if [ ! -z "$CONSOLE_ID" ]; then
            echo "è§¸ç¢° WSGI æ–‡ä»¶..."
            curl -X POST "$API_BASE/consoles/$CONSOLE_ID/send_input/" \
              -H "Authorization: Token $API_TOKEN" \
              -d "input=touch /var/www/${{ secrets.PA_USERNAME }}_pythonanywhere_com_wsgi.py"
          fi
            
          echo "éƒ¨ç½²å®Œæˆ!"
      
      - name: Final Cleanup
        if: always()
        run: |
          echo "æ¸…ç†å®Œæˆï¼Œéƒ¨ç½²çµæŸ"

